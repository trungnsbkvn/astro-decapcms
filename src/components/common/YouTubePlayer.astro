---
/**
 * YouTubePlayer Component
 * Advanced YouTube player with more control and customization
 * Use this for featured videos, hero sections, etc.
 * 
 * Usage:
 * import YouTubePlayer from '~/components/common/YouTubePlayer.astro';
 * <YouTubePlayer id="VIDEO_ID" title="Video title" />
 */

export interface Props {
  id: string;
  title: string;
  autoplay?: boolean;
  muted?: boolean;
  loop?: boolean;
  controls?: boolean;
  showInfo?: boolean;
  rel?: boolean; // Show related videos
  class?: string;
  aspectRatio?: '16/9' | '4/3' | '1/1';
}

const {
  id,
  title,
  autoplay = false,
  muted = false,
  loop = false,
  controls = true,
  showInfo = false,
  rel = false,
  class: className = '',
  aspectRatio = '16/9',
} = Astro.props;

// Build YouTube embed parameters
const params = new URLSearchParams({
  autoplay: autoplay ? '1' : '0',
  mute: muted ? '1' : '0',
  loop: loop ? '1' : '0',
  controls: controls ? '1' : '0',
  showinfo: showInfo ? '1' : '0',
  rel: rel ? '1' : '0',
  modestbranding: '1',
  enablejsapi: '1',
});

if (loop) {
  params.append('playlist', id); // Required for loop
}

const embedUrl = `https://www.youtube.com/embed/${id}?${params.toString()}`;
const thumbnailUrl = `https://i.ytimg.com/vi/${id}/maxresdefault.jpg`;

// Aspect ratio mapping
const aspectRatioClass = {
  '16/9': 'aspect-video',
  '4/3': 'aspect-[4/3]',
  '1/1': 'aspect-square',
}[aspectRatio];
---

<div 
  class:list={[
    'youtube-player-container relative w-full overflow-hidden rounded-lg bg-gray-900',
    aspectRatioClass,
    className
  ]}
  data-youtube-id={id}
>
  {!autoplay ? (
    <!-- Lazy load: Show thumbnail with play button -->
    <div class="youtube-player-placeholder absolute inset-0 cursor-pointer group">
      <!-- Thumbnail -->
      <img 
        src={thumbnailUrl}
        alt={title}
        loading="lazy"
        decoding="async"
        class="absolute inset-0 w-full h-full object-cover"
      />
      
      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/30 group-hover:bg-black/40 transition-colors flex items-center justify-center">
        <!-- Play button -->
        <button 
          type="button"
          class="play-button w-20 h-20 md:w-24 md:h-24 bg-red-600 rounded-full flex items-center justify-center shadow-2xl group-hover:scale-110 transition-transform"
          aria-label={`Play video: ${title}`}
        >
          <svg class="w-10 h-10 md:w-12 md:h-12 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </button>
      </div>
      
      <!-- Video title -->
      {title && (
        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 via-black/60 to-transparent">
          <h3 class="text-white text-base md:text-lg font-semibold line-clamp-2">{title}</h3>
        </div>
      )}
    </div>
  ) : (
    <!-- Autoplay: Load iframe immediately -->
    <iframe
      src={embedUrl}
      title={title}
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
      class="absolute inset-0 w-full h-full"
    ></iframe>
  )}
</div>

<script>
  function initYouTubePlayers() {
    const containers = document.querySelectorAll<HTMLElement>('.youtube-player-container:not(.initialized)');
    
    containers.forEach(container => {
      container.classList.add('initialized');
      
      const placeholder = container.querySelector('.youtube-player-placeholder');
      if (!placeholder) return; // Already has iframe (autoplay)
      
      const playButton = placeholder.querySelector('.play-button');
      if (!playButton) return;
      
      const loadVideo = () => {
        const id = container.dataset.youtubeId;
        if (!id) return;
        
        // Build iframe
        const params = new URLSearchParams({
          autoplay: '1',
          mute: '0',
          rel: '0',
          modestbranding: '1',
          enablejsapi: '1',
        });
        
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${id}?${params.toString()}`;
        iframe.title = container.querySelector('h3')?.textContent || 'YouTube video';
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
        iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
        iframe.setAttribute('allowfullscreen', '');
        iframe.className = 'absolute inset-0 w-full h-full';
        
        // Replace placeholder with iframe
        placeholder.remove();
        container.appendChild(iframe);
      };
      
      // Load on click
      playButton.addEventListener('click', loadVideo, { once: true });
      
      // Optional: Load when visible (comment out if you want click-only)
      // const observer = new IntersectionObserver((entries) => {
      //   entries.forEach(entry => {
      //     if (entry.isIntersecting) {
      //       loadVideo();
      //       observer.disconnect();
      //     }
      //   });
      // }, { threshold: 0.5 });
      // observer.observe(container);
    });
  }
  
  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initYouTubePlayers);
  } else {
    initYouTubePlayers();
  }
  
  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', initYouTubePlayers);
</script>

<style>
  .youtube-player-container {
    container-type: inline-size;
  }
  
  @container (max-width: 640px) {
    .youtube-player-placeholder h3 {
      font-size: 0.875rem;
    }
    
    .play-button {
      width: 4rem;
      height: 4rem;
    }
  }
</style>
