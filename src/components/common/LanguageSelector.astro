---
/**
 * Language Selector Component - Hybrid Translation System
 * - i18n for UI elements (menu, footer, breadcrumbs) - Professional translations
 * - Google Translate ONLY for user content (posts, news, FAQ)
 * - Uses localStorage for consistent language preference
 * - Zero performance cost for Vietnamese (default) users
 */
import { Icon } from 'astro-icon/components';

export interface Props {
  class?: string;
  compact?: boolean;
}

const { class: className = '', compact = false } = Astro.props;

const languages = [
  { code: 'vi', name: 'Tiáº¿ng Viá»‡t', flag: 'ðŸ‡»ðŸ‡³', gtCode: 'vi' },
  { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§', gtCode: 'en' },
  { code: 'zh', name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³', gtCode: 'zh-CN' },
  { code: 'ja', name: 'æ—¥æœ¬èªž', flag: 'ðŸ‡¯ðŸ‡µ', gtCode: 'ja' },
  { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ðŸ‡°ðŸ‡·', gtCode: 'ko' },
];
---

<div class:list={['language-selector relative notranslate', className]} data-language-selector translate="no">
  <button
    type="button"
    class:list={[
      'lang-toggle flex items-center gap-1.5 rounded-lg',
      'hover:bg-gray-100 dark:hover:bg-gray-800',
      'transition-colors duration-200',
      'text-sm font-medium text-gray-700 dark:text-gray-300',
      compact ? 'p-2' : 'px-3 py-2'
    ]}
    aria-label="Select language"
  >
    <Icon name="tabler:world" class="w-4 h-4" />
    <span class="current-lang-code text-xs">VN</span>
    <Icon name="tabler:chevron-down" class="w-3 h-3 transition-transform duration-200" />
  </button>

  <div class="lang-dropdown absolute right-0 mt-2 w-44 py-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 opacity-0 invisible transform scale-95 transition-all duration-200 z-50" role="menu">
    {languages.map((lang) => (
      <button
        type="button"
        class="lang-option w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors notranslate"
        data-lang={lang.code}
        data-gt-code={lang.gtCode}
        role="menuitem"
        translate="no"
      >
        <span class="text-lg leading-none">{lang.flag}</span>
        <span class="flex-1 text-left">{lang.name}</span>
        <Icon name="tabler:check" class="w-4 h-4 opacity-0 check-icon text-primary" />
      </button>
    ))}
  </div>
</div>

<style>
  .language-selector.open .lang-dropdown {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
  }
  .language-selector.open .lang-toggle svg:last-child {
    transform: rotate(180deg);
  }
  .lang-option.active {
    background-color: rgb(243 244 246);
  }
  .lang-option.active .check-icon {
    opacity: 1;
  }
  .dark .lang-option.active {
    background-color: rgb(55 65 81);
  }
</style>

<script>
import { translations } from '~/i18n/translations';

const LANG_KEY = 'site-language';
const langDisplayMap: Record<string, string> = {
  'vi': 'VN', 
  'en': 'EN', 
  'zh-CN': 'CN', 
  'ja': 'JP', 
  'ko': 'KR'
};

// Map Vietnamese text to translation keys for i18n
const textToKeyMap: Record<string, string> = {
  // Company info
  'CÃ´ng ty Luáº­t TNHH Youth & Partners': 'company.legalName',
  'CÃ´ng ty Luáº­t TNHH': 'company.legalPrefix',
  'Youth & Partners': 'company.name',
  'Luáº­t sÆ° Nguyá»…n VÄƒn ThÃ nh': 'company.directorName',
  'GiÃ¡m Ä‘á»‘c, ngÆ°á»i Ä‘áº¡i diá»‡n theo phÃ¡p luáº­t:': 'company.director',
  'Hotline': 'company.hotline',
  'Trá»¥ sá»Ÿ': 'company.headquarters',
  'HÃ  Ná»™i: P316, ThÃ¡p TÃ¢y, Chung cÆ° Há»c viá»‡n Quá»‘c PhÃ²ng, phÆ°á»ng NghÄ©a ÄÃ´, thÃ nh phá»‘ HÃ  Ná»™i.': 'company.addressHanoi',
  'Báº¯c Ninh: Sá»‘ 26 ÄoÃ n Tráº§n Nghiá»‡p, phÆ°á»ng Kinh Báº¯c, tá»‰nh Báº¯c Ninh.': 'company.addressBacNinh',
  'PhÃº Thá»: Sá»‘ 170, Ä‘Æ°á»ng Nguyá»…n VÄƒn Linh, phÆ°á»ng VÄ©nh PhÃºc, tá»‰nh PhÃº Thá».': 'company.addressPhuTho',
  
  // Navigation main
  'Trang chá»§': 'nav.home',
  'Giá»›i thiá»‡u': 'nav.about',
  'Dá»‹ch vá»¥': 'nav.services',
  'Tin tá»©c': 'nav.news',
  'LiÃªn há»‡': 'nav.contact',
  'TÃ¬m kiáº¿m': 'nav.search',
  'PhÃ¡p lÃ½': 'nav.legal',
  'TÆ° váº¥n thÆ°á»ng xuyÃªn': 'nav.consultation',
  'Lao Ä‘á»™ng': 'nav.labor',
  'Äáº§u tÆ° nÆ°á»›c ngoÃ i': 'nav.investment',
  'Dá»‹ch vá»¥ Ä‘Ã¡nh giÃ¡': 'nav.evaluation',
  
  // About section
  'Lá»‹ch sá»­ thÃ nh láº­p': 'about.history',
  'Luáº­t sÆ° vÃ  cá»™ng sá»±': 'about.lawyers',
  'Luáº­t sÆ° vÃ  Cá»™ng sá»±': 'about.lawyers',
  'Giáº£i thÆ°á»Ÿng phÃ¡p lÃ½': 'about.awards',
  'Cáº£m nháº­n khÃ¡ch hÃ ng': 'about.testimonials',
  'TÃ´n chá»‰ hoáº¡t Ä‘á»™ng': 'about.principles',
  'Há»“ sÆ¡ nÄƒng lá»±c': 'about.capabilities',
  'Táº§m nhÃ¬n - sá»© má»‡nh': 'about.vision',
  'Sá»± kiá»‡n ná»™i bá»™': 'about.internalEvents',
  'Báº£o vá»‡ dá»¯ liá»‡u cÃ¡ nhÃ¢n': 'about.dataProtection',
  'Vá» chÃºng tÃ´i': 'about.aboutUs',
  
  // Legal services menu
  'PhÃ¡p lÃ½ thÃ nh láº­p Doanh nghiá»‡p': 'legal.enterprise',
  'Doanh nghiá»‡p': 'legal.enterprise',
  'Kinh doanh thÆ°Æ¡ng máº¡i': 'legal.commercial',
  'Há»£p Ä‘á»“ng dÃ¢n sá»±, thÆ°Æ¡ng máº¡i': 'legal.contract',
  'Äáº¥t Ä‘ai': 'legal.land',
  'HÃ´n nhÃ¢n gia Ä‘Ã¬nh': 'legal.marriage',
  'HÃ´n nhÃ¢n vÃ  gia Ä‘Ã¬nh': 'legal.marriage',
  'Thá»«a káº¿, di chÃºc': 'legal.inheritance',
  'Sá»Ÿ há»¯u trÃ­ tuá»‡': 'legal.intellectual',
  'Giáº¥y phÃ©p kinh doanh': 'legal.license',
  'Giáº¥y phÃ©p con': 'legal.subLicense',
  'DÃ¢n sá»±': 'legal.civil',
  'HÃ¬nh sá»±': 'legal.criminal',
  'Tranh tá»¥ng, tá»‘ tá»¥ng': 'legal.litigation',
  'PhÃ¡p lÃ½ khÃ¡c': 'legal.other',
  
  // Consultation services
  'TÆ° váº¥n phÃ¡p luáº­t thÆ°á»ng xuyÃªn': 'consultation.regular',
  'Dá»‹ch vá»¥ luáº­t sÆ° riÃªng': 'consultation.privateLawyer',
  'KhÃ¡i niá»‡m TÆ° váº¥n thÆ°á»ng xuyÃªn': 'consultation.concept',
  'VÃ¬ sao doanh nghiá»‡p cáº§n tÆ° váº¥n thÆ°á»ng xuyÃªn': 'consultation.whyNeeded',
  'Máº«u há»£p Ä‘á»“ng dá»‹ch vá»¥': 'consultation.contractTemplate',
  'PhÃ­ dá»‹ch vá»¥ tÆ° váº¥n': 'consultation.serviceFee',
  'Quy trÃ¬nh tÆ° váº¥n': 'consultation.process',
  'Äiá»ƒm máº¡nh cá»§a Youth & Partners': 'consultation.strengths',
  'PhÃ¡p lÃ½ tÆ° váº¥n thÆ°á»ng xuyÃªn khÃ¡c': 'consultation.other',
  
  // Labor services menu
  'Ná»™i quy lao Ä‘á»™ng - Thá»a Æ°á»›c': 'labor.regulations',
  'Ná»™i quy - Thá»a Æ°á»›c': 'labor.regulations',
  'Thá»i giá» lÃ m viá»‡c': 'labor.workingHours',
  'Tiá»n lÆ°Æ¡ng & PhÃºc lá»£i': 'labor.salary',
  'LÆ°Æ¡ng & PhÃºc lá»£i': 'labor.salary',
  'Há»£p Ä‘á»“ng lao Ä‘á»™ng, Ä‘Ã o táº¡o': 'labor.contracts',
  'Cháº¥m dá»©t há»£p Ä‘á»“ng': 'labor.termination',
  'Xá»­ lÃ½ ká»· luáº­t': 'labor.discipline',
  'Quáº¥y rá»‘i tÃ¬nh dá»¥c': 'labor.harassment',
  'Tranh cháº¥p lao Ä‘á»™ng': 'labor.disputes',
  'PhÃ¡p luáº­t lao Ä‘á»™ng khÃ¡c': 'labor.other',
  'PhÃ¡p lÃ½ lao Ä‘á»™ng khÃ¡c': 'labor.other',
  
  // Investment services menu
  'ThÃ nh láº­p má»›i dá»± Ã¡n': 'investment.newProjects',
  'Äiá»u chá»‰nh dá»± Ã¡n Ä‘áº§u tÆ°': 'investment.projectAdjustment',
  'Chuyá»ƒn nhÆ°á»£ng dá»± Ã¡n': 'investment.transfer',
  'Hiá»‡n diá»‡n thÆ°Æ¡ng máº¡i': 'investment.presence',
  'Luáº­t sÆ° tÆ° váº¥n tiáº¿ng Anh': 'investment.englishLawyer',
  'Luáº­t sÆ° tÆ° váº¥n tiáº¿ng Nháº­t': 'investment.japaneseLawyer',
  'Luáº­t sÆ° tÆ° váº¥n tiáº¿ng Trung Quá»‘c': 'investment.chineseLawyer',
  'Giáº¥y phÃ©p lao Ä‘á»™ng': 'investment.workPermit',
  'PhÃ¡p lÃ½ ngÆ°á»i nÆ°á»›c ngoÃ i': 'investment.foreignerLaw',
  
  // Evaluation services menu
  'KhÃ¡i niá»‡m Ä‘Ã¡nh giÃ¡': 'evaluation.concept',
  'Lá»£i Ã­ch Ä‘Ã¡nh giÃ¡': 'evaluation.benefits',
  'Lá»£i Ã­ch cá»§a viá»‡c Ä‘Ã¡nh giÃ¡': 'evaluation.benefits',
  'PhÃ­ dá»‹ch vá»¥ Ä‘Ã¡nh giÃ¡': 'evaluation.pricing',
  'Quy trÃ¬nh Ä‘Ã¡nh giÃ¡': 'evaluation.process',
  'Dá»‹ch vá»¥ Ä‘Ã¡nh giÃ¡ cho doanh nghiá»‡p': 'evaluation.business',
  'Dá»‹ch vá»¥ ÄÃ¡nh giÃ¡ cho Doanh nghiá»‡p': 'evaluation.business',
  'Dá»‹ch vá»¥ Ä‘Ã¡nh giÃ¡ trÆ°á»›c kiá»ƒm toÃ¡n': 'evaluation.preAudit',
  'Dá»‹ch vá»¥ Ä‘Ã¡nh giÃ¡ tiá»n tráº¡m': 'evaluation.preAudit',
  'TiÃªu chuáº©n xÃ£ há»™i': 'evaluation.standards',
  'CÃ¡c bá»™ tiÃªu chuáº©n TNXH': 'evaluation.standards',
  'TiÃªu chuáº©n RBA': 'evaluation.rba',
  'Nhá»¯ng sai sÃ³t thÆ°á»ng gáº·p cá»§a DN': 'evaluation.mistakes',
  'CÃ¡c lá»—i thÆ°á»ng gáº·p cá»§a doanh nghiá»‡p': 'evaluation.mistakes',
  
  // News categories
  'Tin tá»©c phÃ¡p lÃ½': 'news.legal',
  'BÃ¬nh luáº­n phÃ¡p lÃ½': 'news.commentary',
  'CÃ¡c vá»¥ viá»‡c ná»•i báº­t': 'news.highlights',
  'Há»™i tháº£o phÃ¡p lÃ½': 'news.seminars',
  'VÄƒn báº£n phÃ¡p lÃ½': 'news.documents',
  'LiÃªn há»‡ tÆ° váº¥n': 'news.contact',
  'ThÃ´ng tin tuyá»ƒn dá»¥ng': 'news.recruitment',
  'Tin tá»©c - LiÃªn há»‡': 'news.newsAndContact',
  'Äáº§u tÆ° & NÆ°á»›c ngoÃ i': 'nav.investmentAndForeign',
  
  // Lawyer locations
  'Luáº­t sÆ° HÃ  Ná»™i': 'news.lawyerHanoi',
  'Luáº­t sÆ° PhÃº Thá»': 'news.lawyerPhuTho',
  'Luáº­t sÆ° Báº¯c Ninh': 'news.lawyerBacNinh',
  'Luáº­t sÆ° Báº¯c Giang': 'news.lawyerBacGiang',
  'Luáº­t sÆ° Háº£i PhÃ²ng': 'news.lawyerHaiPhong',
  'Luáº­t sÆ° HÆ°ng YÃªn': 'news.lawyerHungYen',
  'Luáº­t sÆ° Ninh BÃ¬nh': 'news.lawyerNinhBinh',
  'Luáº­t sÆ° TuyÃªn Quang': 'news.lawyerTuyenQuang',
  'Luáº­t sÆ° ThÃ¡i NguyÃªn': 'news.lawyerThaiNguyen',
  
  // Footer sections
  'Äiá»u khoáº£n chung': 'footer.terms',
  'ChÃ­nh sÃ¡ch Báº£o vá»‡ dá»¯ liá»‡u': 'footer.privacy',
  'ChÃ­nh sÃ¡ch báº£o máº­t': 'footer.privacy',
  'Äiá»u khoáº£n sá»­ dá»¥ng': 'footer.terms',
  'Dá»‹ch vá»¥ cá»§a Y&P': 'footer.servicesYP',
  'Äáº§u tÆ° vÃ  NgÆ°á»i nÆ°á»›c ngoÃ i': 'footer.investmentForeign',

  // Common UI elements
  'Äá»c thÃªm': 'common.readMore',
  'Xem thÃªm': 'common.readMore',
  'TÃ¬m hiá»ƒu thÃªm': 'common.learnMore',
  'LiÃªn há»‡ chÃºng tÃ´i': 'common.contactUs',
  'Nháº­n bÃ¡o giÃ¡': 'common.getQuote',
  'Gá»­i': 'common.submit',
  'Há»§y': 'common.cancel',
  'ÄÃ³ng': 'common.close',
  'Äang táº£i...': 'common.loading',
  'Lá»—i': 'common.error',
  'ThÃ nh cÃ´ng': 'common.success',
  'Cáº£nh bÃ¡o': 'common.warning',
  'ThÃ´ng tin': 'common.info',
  'TÃ¬m kiáº¿m...': 'common.search',
  'KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£': 'common.noResults',
  'Vá» Ä‘áº§u trang': 'common.backToTop',
  'Chia sáº»': 'common.share',
  'Share:': 'common.share',
  'In': 'common.print',
  'Táº£i xuá»‘ng': 'common.download',
  'Xem táº¥t cáº£': 'common.viewAll',
  'Trá»Ÿ vá» chuyÃªn trang': 'common.backToPage',
  'BÃ i viáº¿t liÃªn quan': 'common.relatedPosts',
  'BÃ i má»›i hÆ¡n': 'common.newerPosts',
  'BÃ i cÅ© hÆ¡n': 'common.olderPosts',
  'Má»¥c lá»¥c': 'common.tableOfContents',
  'Gá»­i thÃ´ng tin': 'common.sendInfo',
  'LiÃªn há»‡ Ä‘á»ƒ Ä‘Æ°á»£c tÆ° váº¥n': 'common.contactForConsult',
  'Tá»•ng cá»™ng': 'common.totalPosts',
  'bÃ i viáº¿t': 'common.posts',
  
  // Post/Blog labels
  'TÃ¡c giáº£:': 'post.author',
  'Tham váº¥n bá»Ÿi:': 'post.reviewedBy',
  'phÃºt Ä‘á»c': 'post.readingTime',
  'NgÃ y Ä‘Äƒng': 'post.publishDate',
  'Cáº­p nháº­t': 'post.updateDate',
  'Danh má»¥c': 'post.category',
  'Tháº»': 'post.tags',
  
  // Contact page
  'LiÃªn há»‡ vá»›i chÃºng tÃ´i!': 'contact.title',
  'HÃ£y Ä‘á»ƒ láº¡i thÃ´ng tin bÃªn dÆ°á»›i': 'contact.subtitle',
  'Äá»™i ngÅ© há»— trá»£ cá»§a chÃºng tÃ´i luÃ´n sáºµn lÃ²ng giÃºp Ä‘á»¡ báº¡n.': 'contact.description',
  'Äá»™i ngÅ© há»— trá»£ cá»§a chÃºng tÃ´i thÆ°á»ng pháº£n há»“i trong vÃ²ng 24 giá» lÃ m viá»‡c.': 'contact.responseTime',
  'Há»— trá»£ chung': 'contact.generalSupport',
  'LiÃªn há»‡ vá»›i chÃºng tÃ´i Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£ vá» cÃ¡c váº¥n Ä‘á» phÃ¡p lÃ½ chung.': 'contact.generalDesc',
  'LiÃªn há»‡ bá»™ pháº­n tÆ° váº¥n': 'contact.consultDept',
  'TrÃ² chuyá»‡n vá»›i chÃºng tÃ´i Ä‘á»ƒ giáº£i Ä‘Ã¡p cÃ¡c cÃ¢u há»i vá» dá»‹ch vá»¥ tÆ° váº¥n phÃ¡p lÃ½.': 'contact.consultDesc',
  'Há»— trá»£ ká»¹ thuáº­t': 'contact.techSupport',
  'LiÃªn há»‡ vá»›i chÃºng tÃ´i khi báº¡n gáº·p váº¥n Ä‘á» ká»¹ thuáº­t.': 'contact.techDesc',
  'ChÃºng tÃ´i luÃ´n sáºµn sÃ ng há»— trá»£ báº¡n!': 'contact.readyToHelp',
  
  // Forms
  'Há» tÃªn': 'forms.name',
  'Há» vÃ  tÃªn': 'forms.name',
  'Sá»‘ Ä‘iá»‡n thoáº¡i': 'forms.phone',
  'Ná»™i dung tin nháº¯n': 'forms.message',
  'Ná»™i dung': 'forms.message',
  'TiÃªu Ä‘á»': 'forms.subject',
  'CÃ´ng ty': 'forms.company',
  'Chá»©c vá»¥': 'forms.position',
  'Báº¯t buá»™c': 'forms.required',
  'TÃ¹y chá»n': 'forms.optional',
  'Gá»­i tin nháº¯n': 'forms.sendMessage',
  'Gá»­i yÃªu cáº§u': 'forms.sendMessage',
  'Äang gá»­i...': 'forms.sending',
  'ÄÃ£ gá»­i thÃ nh cÃ´ng!': 'forms.sent',
  
  // Language selector
  'Chá»n ngÃ´n ngá»¯': 'language.selectLanguage',
  'NgÃ´n ngá»¯ hiá»‡n táº¡i': 'language.currentLanguage',
  
  // Error pages
  'KhÃ´ng tÃ¬m tháº¥y trang báº¡n yÃªu cáº§u': 'error.notFound',
  'Xin lá»—i, chÃºng tÃ´i khÃ´ng thá»ƒ tÃ¬m tháº¥y trang nÃ y.': 'error.pageNotFound',
  'NhÆ°ng Ä‘á»«ng lo, báº¡n cÃ³ thá»ƒ tÃ¬m tháº¥y nhiá»u thÃ´ng tin khÃ¡c trÃªn trang chá»§ cá»§a chÃºng tÃ´i.': 'error.redirectMessage',
  'Trá»Ÿ vá» trang chá»§': 'error.backToHome',
  
  // About/Motto
  'PhÆ°Æ¡ng chÃ¢m hoáº¡t Ä‘á»™ng:': 'about.motto',
  'Thá»i Gian â€“ Táº­n TÃ¢m â€“ Táº­n Lá»±c': 'about.mottoText',
  
  // Search
  'TÃ¬m kiáº¿m bÃ i viáº¿t...': 'search.placeholder',
  'Nháº­p tá»« khÃ³a Ä‘á»ƒ tÃ¬m kiáº¿m...': 'search.enterKeyword',
  
  // Author pages
  'LiÃªn há»‡ vá»›i tÃ¡c giáº£': 'contact.contactAuthor',
  
  // Homepage sections
  'Tin má»›i nháº¥t': 'news.latest',
  'Cáº£m nháº­n cá»§a khÃ¡ch hÃ ng': 'about.testimonials',
  'Äá»‘i tÃ¡c vÃ  khÃ¡ch hÃ ng cá»§a chÃºng tÃ´i': 'company.partners',
  'TÃ´n chá»‰ hoáº¡t Ä‘á»™ng cá»§a chÃºng tÃ´i': 'about.principles',
  'LiÃªn há»‡ Ä‘á»ƒ Ä‘Æ°á»£c tÆ° váº¥n ngay': 'contact.consultNow',
  'LiÃªn há»‡ ngay': 'common.contactNow',
  'Theo dÃµi chÃºng tÃ´i': 'common.followUs',
  'ChuyÃªn viÃªn phÃ¡p lÃ½': 'common.legalStaff',
  'KhÃ¡ch hÃ ng hÃ i lÃ²ng': 'common.satisfiedClients',
  'Vá»¥ tháº¯ng kiá»‡n': 'common.casesWon',
};

function getSavedLang(): string {
  try {
    return localStorage.getItem(LANG_KEY) || 'vi';
  } catch {
    return 'vi';
  }
}

function saveLang(lang: string): void {
  try {
    localStorage.setItem(LANG_KEY, lang);
  } catch { /* ignore */ }
}

function setGTCookie(lang: string): void {
  // Clear existing cookies on all domains
  document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
  document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=' + window.location.hostname;
  document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.yplawfirm.vn';
  
  if (lang !== 'vi') {
    const cookieValue = `/vi/${lang}`;
    document.cookie = `googtrans=${cookieValue}; path=/; max-age=31536000`;
    document.cookie = `googtrans=${cookieValue}; path=/; max-age=31536000; domain=${window.location.hostname}`;
    document.cookie = `googtrans=${cookieValue}; path=/; max-age=31536000; domain=.yplawfirm.vn`;
  }
}

function getTranslation(lang: string, key: string): string | null {
  // The translations object is structured as: translations[section][lang][key]
  const keys = key.split('.');
  if (keys.length !== 2) return null;
  
  const [section, subKey] = keys;
  const sectionData = (translations as any)[section];
  if (!sectionData) return null;
  
  const langData = sectionData[lang];
  if (!langData) return null;
  
  return langData[subKey] || null;
}

function translateTextNode(node: Text, lang: string): boolean {
  const text = node.textContent?.trim();
  if (!text) return false;

  const key = textToKeyMap[text];
  if (key) {
    const translation = getTranslation(lang, key);
    if (translation && node.textContent) {
      node.textContent = node.textContent.replace(text, translation);
      return true;
    }
  }
  return false;
}

function translateElement(element: Element, lang: string): void {
  // Skip user-content (handled by Google Translate)
  if (element.classList.contains('user-content') || element.hasAttribute('data-user-content')) {
    return;
  }

  const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT);
  while (walker.nextNode()) {
    const node = walker.currentNode as Text;
    const parent = node.parentElement;
    if (parent?.closest('.user-content, [data-user-content]')) continue;
    translateTextNode(node, lang);
  }
}

function applyTranslations(lang: string): void {
  if (lang === 'vi') {
    document.documentElement.classList.remove('i18n-loading');
    return;
  }

  // First, translate all elements with data-i18n attributes
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (key) {
      const translation = getTranslation(lang, key);
      if (translation) {
        // Check if the element has child elements (like icons)
        const hasChildElements = el.querySelector('*');
        if (hasChildElements) {
          // Only update direct text nodes
          Array.from(el.childNodes).forEach(node => {
            if (node.nodeType === Node.TEXT_NODE && node.textContent?.trim()) {
              node.textContent = translation;
            }
          });
        } else {
          el.textContent = translation;
        }
      }
    }
  });

  // Translate placeholder attributes
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (key) {
      const translation = getTranslation(lang, key);
      if (translation) {
        el.setAttribute('placeholder', translation);
      }
    }
  });

  // Translate header
  const header = document.querySelector('header');
  if (header) translateElement(header, lang);

  // Translate footer
  const footer = document.querySelector('footer');
  if (footer) translateElement(footer, lang);

  // Translate navigation
  document.querySelectorAll('nav').forEach(el => translateElement(el, lang));

  // Translate elements with notranslate class (these are excluded from Google Translate)
  document.querySelectorAll('.notranslate').forEach(el => translateElement(el, lang));

  // Translate breadcrumbs
  document.querySelectorAll('nav[aria-label="Breadcrumb"]').forEach(el => translateElement(el, lang));

  // Remove loading class
  document.documentElement.classList.remove('i18n-loading');
}

function loadGoogleTranslate(targetLang: string): void {
  const win = window as any;

  // Ensure notranslate elements have translate="no"
  document.querySelectorAll('.notranslate, header, footer, nav').forEach(el => {
    el.setAttribute('translate', 'no');
  });

  if (document.querySelector('script[src*="translate.google.com"]')) {
    setTimeout(() => triggerTranslation(targetLang), 100);
    return;
  }

  win.googleTranslateElementInit = function() {
    new win.google.translate.TranslateElement({
      pageLanguage: 'vi',
      includedLanguages: 'en,zh-CN,ja,ko',
      autoDisplay: false,
      layout: win.google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google_translate_element_hidden');

    let attempts = 0;
    const tryTrigger = () => {
      attempts++;
      if (attempts < 10) {
        triggerTranslation(targetLang);
        setTimeout(tryTrigger, 500);
      }
    };
    setTimeout(tryTrigger, 500);
  };

  const script = document.createElement('script');
  script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
  script.async = true;
  document.head.appendChild(script);
}

function triggerTranslation(targetLang: string): void {
  const selectEl = document.querySelector('.goog-te-combo') as HTMLSelectElement;
  if (selectEl && selectEl.value !== targetLang) {
    selectEl.value = targetLang;
    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
  }
}

function initDropdown(): void {
  const savedLang = getSavedLang();
  const selectors = document.querySelectorAll('[data-language-selector]');

  selectors.forEach(selector => {
    const toggle = selector.querySelector('.lang-toggle');
    const options = selector.querySelectorAll('.lang-option');
    const currentCode = selector.querySelector('.current-lang-code');

    // Update display
    if (currentCode) {
      currentCode.textContent = langDisplayMap[savedLang] || 'VN';
    }

    // Mark active option
    options.forEach(opt => {
      opt.classList.remove('active');
      if ((opt as HTMLElement).dataset.gtCode === savedLang) {
        opt.classList.add('active');
      }
    });

    // Toggle dropdown
    toggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      selector.classList.toggle('open');
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!selector.contains(e.target as Node)) {
        selector.classList.remove('open');
      }
    });

    // Language selection
    options.forEach(option => {
      option.addEventListener('click', () => {
        const gtCode = (option as HTMLElement).dataset.gtCode || 'vi';
        saveLang(gtCode);
        setGTCookie(gtCode);
        selector.classList.remove('open');
        location.reload();
      });
    });
  });
}

function init(): void {
  const savedLang = getSavedLang();

  // Add translate="no" to all notranslate elements
  document.querySelectorAll('.notranslate').forEach(el => {
    el.setAttribute('translate', 'no');
  });
  document.querySelector('header')?.setAttribute('translate', 'no');
  document.querySelector('footer')?.setAttribute('translate', 'no');

  // Apply i18n translations first
  applyTranslations(savedLang);

  // Initialize dropdown
  initDropdown();

  // Load Google Translate for user content if non-Vietnamese
  if (savedLang !== 'vi') {
    setGTCookie(savedLang);
    setTimeout(() => loadGoogleTranslate(savedLang), 100);
  }
}

// Run as early as possible
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

<!-- Hidden element for Google Translate -->
<div id="google_translate_element_hidden" style="display:none!important;height:0!important;overflow:hidden!important;"></div>