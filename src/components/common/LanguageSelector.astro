---
/**
 * Language Selector Component - Hybrid Translation System
 * - i18n for UI elements (menu, footer, breadcrumbs) - Professional translations
 * - Google Translate ONLY for user content (posts, news, FAQ)
 * - Uses localStorage for consistent language preference
 * - Zero performance cost for Vietnamese (default) users
 */
import { Icon } from 'astro-icon/components';

export interface Props {
  class?: string;
  compact?: boolean;
}

const { class: className = '', compact = false } = Astro.props;

const languages = [
  { code: 'vi', name: 'Tiáº¿ng Viá»‡t', flag: 'ðŸ‡»ðŸ‡³', gtCode: 'vi' },
  { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§', gtCode: 'en' },
  { code: 'zh', name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³', gtCode: 'zh-CN' },
  { code: 'ja', name: 'æ—¥æœ¬èªž', flag: 'ðŸ‡¯ðŸ‡µ', gtCode: 'ja' },
  { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ðŸ‡°ðŸ‡·', gtCode: 'ko' },
];
---

<div class:list={['language-selector relative notranslate', className]} data-language-selector translate="no">
  <button
    type="button"
    class:list={[
      'lang-toggle flex items-center gap-1.5 rounded-lg',
      'hover:bg-gray-100 dark:hover:bg-gray-800',
      'transition-colors duration-200',
      'text-sm font-medium text-gray-700 dark:text-gray-300',
      compact ? 'p-2' : 'px-3 py-2'
    ]}
    aria-label="Select language"
  >
    <Icon name="tabler:world" class="w-4 h-4" />
    <span class="current-lang-code text-xs">VN</span>
    <Icon name="tabler:chevron-down" class="w-3 h-3 transition-transform duration-200" />
  </button>

  <div class="lang-dropdown absolute right-0 mt-2 w-44 py-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 opacity-0 invisible transform scale-95 transition-all duration-200 z-50" role="menu">
    {languages.map((lang) => (
      <button
        type="button"
        class="lang-option w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors notranslate"
        data-lang={lang.code}
        data-gt-code={lang.gtCode}
        role="menuitem"
        translate="no"
      >
        <span class="text-lg leading-none">{lang.flag}</span>
        <span class="flex-1 text-left">{lang.name}</span>
        <Icon name="tabler:check" class="w-4 h-4 opacity-0 check-icon text-primary" />
      </button>
    ))}
  </div>
</div>

<style>
  .language-selector.open .lang-dropdown {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
  }
  .language-selector.open .lang-toggle svg:last-child {
    transform: rotate(180deg);
  }
  .lang-option.active {
    background-color: rgb(243 244 246);
  }
  .lang-option.active .check-icon {
    opacity: 1;
  }
  .dark .lang-option.active {
    background-color: rgb(55 65 81);
  }
</style>

<script>
import { translations } from '~/i18n/translations';

const LANG_KEY = 'site-language';
const langDisplayMap: Record<string, string> = {
  'vi': 'VN', 
  'en': 'EN', 
  'zh-CN': 'CN', 
  'ja': 'JP', 
  'ko': 'KR'
};

// Map Vietnamese text to translation keys for i18n
const textToKeyMap: Record<string, string> = {
  // Company info
  'CÃ´ng ty Luáº­t TNHH Youth & Partners': 'company.legalName',
  'Youth & Partners': 'company.name',
  'Luáº­t sÆ° Nguyá»…n VÄƒn ThÃ nh': 'company.director',
  // Navigation
  'Trang chá»§': 'nav.home',
  'Giá»›i thiá»‡u': 'nav.about',
  'Dá»‹ch vá»¥': 'nav.services',
  'PhÃ¡p lÃ½': 'nav.legal',
  'TÆ° váº¥n thÆ°á»ng xuyÃªn': 'nav.consultation',
  'Lao Ä‘á»™ng': 'nav.labor',
  'Äáº§u tÆ° nÆ°á»›c ngoÃ i': 'nav.investment',
  'Dá»‹ch vá»¥ Ä‘Ã¡nh giÃ¡': 'nav.evaluation',
  'Tin tá»©c': 'nav.news',
  'LiÃªn há»‡': 'nav.contact',
  'TÃ¬m kiáº¿m': 'nav.search',
  // About section
  'Lá»‹ch sá»­ thÃ nh láº­p': 'about.history',
  'Luáº­t sÆ° vÃ  cá»™ng sá»±': 'about.lawyers',
  'Giáº£i thÆ°á»Ÿng phÃ¡p lÃ½': 'about.awards',
  'Cáº£m nháº­n khÃ¡ch hÃ ng': 'about.testimonials',
  'TÃ´n chá»‰ hoáº¡t Ä‘á»™ng': 'about.principles',
  'Há»“ sÆ¡ nÄƒng lá»±c': 'about.capabilities',
  // Legal services
  'Doanh nghiá»‡p': 'legal.enterprise',
  'Há»£p Ä‘á»“ng': 'legal.contract',
  'Äáº¥t Ä‘ai': 'legal.land',
  'HÃ´n nhÃ¢n gia Ä‘Ã¬nh': 'legal.marriage',
  'Thá»«a káº¿': 'legal.inheritance',
  'Sá»Ÿ há»¯u trÃ­ tuá»‡': 'legal.intellectual',
  'Giáº¥y phÃ©p': 'legal.license',
  'Tranh tá»¥ng': 'legal.litigation',
  // Labor
  'Há»£p Ä‘á»“ng lao Ä‘á»™ng': 'labor.contract',
  'Báº£o hiá»ƒm xÃ£ há»™i': 'labor.insurance',
  'An toÃ n lao Ä‘á»™ng': 'labor.safety',
  'Ná»™i quy lao Ä‘á»™ng': 'labor.regulation',
  'Tranh cháº¥p lao Ä‘á»™ng': 'labor.dispute',
  'Giáº¥y phÃ©p lao Ä‘á»™ng': 'labor.permit',
  // Investment
  'ThÃ nh láº­p cÃ´ng ty': 'investment.establish',
  'Giáº¥y phÃ©p Ä‘áº§u tÆ°': 'investment.license',
  'ÄÄƒng kÃ½ Ä‘áº§u tÆ°': 'investment.registration',
  'Æ¯u Ä‘Ã£i Ä‘áº§u tÆ°': 'investment.incentives',
  'M&A': 'investment.ma',
  'ThoÃ¡i vá»‘n': 'investment.divestment',
  // Evaluation
  'ÄÃ¡nh giÃ¡ RBA': 'evaluation.rba',
  'ÄÃ¡nh giÃ¡ SMETA': 'evaluation.smeta',
  'ÄÃ¡nh giÃ¡ SA8000': 'evaluation.sa8000',
  'ÄÃ¡nh giÃ¡ BSCI': 'evaluation.bsci',
  'TÆ° váº¥n tuÃ¢n thá»§': 'evaluation.compliance',
  // Footer
  'GiÃ¡m Ä‘á»‘c, ngÆ°á»i Ä‘áº¡i diá»‡n theo phÃ¡p luáº­t:': 'footer.director',
  'ChÃ­nh sÃ¡ch báº£o máº­t': 'footer.privacy',
  'Äiá»u khoáº£n sá»­ dá»¥ng': 'footer.terms',
  // Common
  'Xem thÃªm': 'common.readMore',
  'TÃ¬m hiá»ƒu thÃªm': 'common.learnMore',
  'LiÃªn há»‡ ngay': 'common.contactNow',
  'TÆ° váº¥n miá»…n phÃ­': 'common.freeConsult',
  'Gá»i ngay': 'common.callNow',
  'Gá»­i': 'common.send',
  'Äang táº£i...': 'common.loading',
  'ÄÃ³ng': 'common.close',
  'Quay láº¡i': 'common.back',
  'Tiáº¿p theo': 'common.next',
  'TrÆ°á»›c': 'common.prev',
  'Chia sáº»': 'common.share',
  'BÃ i viáº¿t liÃªn quan': 'common.relatedPosts',
  'Xem táº¥t cáº£': 'common.viewAll',
  // Post
  'TÃ¡c giáº£:': 'post.author',
  'Tham váº¥n bá»Ÿi:': 'post.reviewedBy',
  'phÃºt Ä‘á»c': 'post.readingTime',
  // Contact form
  'Há» vÃ  tÃªn': 'forms.name',
  'Sá»‘ Ä‘iá»‡n thoáº¡i': 'forms.phone',
  'Email': 'forms.email',
  'Ná»™i dung': 'forms.message',
  'Gá»­i yÃªu cáº§u': 'forms.submit',
};

function getSavedLang(): string {
  try {
    return localStorage.getItem(LANG_KEY) || 'vi';
  } catch {
    return 'vi';
  }
}

function saveLang(lang: string): void {
  try {
    localStorage.setItem(LANG_KEY, lang);
  } catch { /* ignore */ }
}

function setGTCookie(lang: string): void {
  // Clear existing cookies on all domains
  document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
  document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=' + window.location.hostname;
  document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.yplawfirm.vn';
  
  if (lang !== 'vi') {
    const cookieValue = `/vi/${lang}`;
    document.cookie = `googtrans=${cookieValue}; path=/; max-age=31536000`;
    document.cookie = `googtrans=${cookieValue}; path=/; max-age=31536000; domain=${window.location.hostname}`;
    document.cookie = `googtrans=${cookieValue}; path=/; max-age=31536000; domain=.yplawfirm.vn`;
  }
}

function getTranslation(lang: string, key: string): string | null {
  // The translations object is structured as: translations[section][lang][key]
  const keys = key.split('.');
  if (keys.length !== 2) return null;
  
  const [section, subKey] = keys;
  const sectionData = (translations as any)[section];
  if (!sectionData) return null;
  
  const langData = sectionData[lang];
  if (!langData) return null;
  
  return langData[subKey] || null;
}

function translateTextNode(node: Text, lang: string): boolean {
  const text = node.textContent?.trim();
  if (!text) return false;

  const key = textToKeyMap[text];
  if (key) {
    const translation = getTranslation(lang, key);
    if (translation && node.textContent) {
      node.textContent = node.textContent.replace(text, translation);
      return true;
    }
  }
  return false;
}

function translateElement(element: Element, lang: string): void {
  // Skip user-content (handled by Google Translate)
  if (element.classList.contains('user-content') || element.hasAttribute('data-user-content')) {
    return;
  }

  const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT);
  while (walker.nextNode()) {
    const node = walker.currentNode as Text;
    const parent = node.parentElement;
    if (parent?.closest('.user-content, [data-user-content]')) continue;
    translateTextNode(node, lang);
  }
}

function applyTranslations(lang: string): void {
  if (lang === 'vi') {
    document.documentElement.classList.remove('i18n-loading');
    return;
  }

  // Translate header
  const header = document.querySelector('header');
  if (header) translateElement(header, lang);

  // Translate footer
  const footer = document.querySelector('footer');
  if (footer) translateElement(footer, lang);

  // Translate navigation
  document.querySelectorAll('nav').forEach(el => translateElement(el, lang));

  // Translate elements with notranslate class (these are excluded from Google Translate)
  document.querySelectorAll('.notranslate').forEach(el => translateElement(el, lang));

  // Translate breadcrumbs
  document.querySelectorAll('nav[aria-label="Breadcrumb"]').forEach(el => translateElement(el, lang));

  // Remove loading class
  document.documentElement.classList.remove('i18n-loading');
}

function loadGoogleTranslate(targetLang: string): void {
  const win = window as any;

  // Ensure notranslate elements have translate="no"
  document.querySelectorAll('.notranslate, header, footer, nav').forEach(el => {
    el.setAttribute('translate', 'no');
  });

  if (document.querySelector('script[src*="translate.google.com"]')) {
    setTimeout(() => triggerTranslation(targetLang), 100);
    return;
  }

  win.googleTranslateElementInit = function() {
    new win.google.translate.TranslateElement({
      pageLanguage: 'vi',
      includedLanguages: 'en,zh-CN,ja,ko',
      autoDisplay: false,
      layout: win.google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google_translate_element_hidden');

    let attempts = 0;
    const tryTrigger = () => {
      attempts++;
      if (attempts < 10) {
        triggerTranslation(targetLang);
        setTimeout(tryTrigger, 500);
      }
    };
    setTimeout(tryTrigger, 500);
  };

  const script = document.createElement('script');
  script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
  script.async = true;
  document.head.appendChild(script);
}

function triggerTranslation(targetLang: string): void {
  const selectEl = document.querySelector('.goog-te-combo') as HTMLSelectElement;
  if (selectEl && selectEl.value !== targetLang) {
    selectEl.value = targetLang;
    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
  }
}

function initDropdown(): void {
  const savedLang = getSavedLang();
  const selectors = document.querySelectorAll('[data-language-selector]');

  selectors.forEach(selector => {
    const toggle = selector.querySelector('.lang-toggle');
    const options = selector.querySelectorAll('.lang-option');
    const currentCode = selector.querySelector('.current-lang-code');

    // Update display
    if (currentCode) {
      currentCode.textContent = langDisplayMap[savedLang] || 'VN';
    }

    // Mark active option
    options.forEach(opt => {
      opt.classList.remove('active');
      if ((opt as HTMLElement).dataset.gtCode === savedLang) {
        opt.classList.add('active');
      }
    });

    // Toggle dropdown
    toggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      selector.classList.toggle('open');
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!selector.contains(e.target as Node)) {
        selector.classList.remove('open');
      }
    });

    // Language selection
    options.forEach(option => {
      option.addEventListener('click', () => {
        const gtCode = (option as HTMLElement).dataset.gtCode || 'vi';
        saveLang(gtCode);
        setGTCookie(gtCode);
        selector.classList.remove('open');
        location.reload();
      });
    });
  });
}

function init(): void {
  const savedLang = getSavedLang();

  // Add translate="no" to all notranslate elements
  document.querySelectorAll('.notranslate').forEach(el => {
    el.setAttribute('translate', 'no');
  });
  document.querySelector('header')?.setAttribute('translate', 'no');
  document.querySelector('footer')?.setAttribute('translate', 'no');

  // Apply i18n translations first
  applyTranslations(savedLang);

  // Initialize dropdown
  initDropdown();

  // Load Google Translate for user content if non-Vietnamese
  if (savedLang !== 'vi') {
    setGTCookie(savedLang);
    setTimeout(() => loadGoogleTranslate(savedLang), 100);
  }
}

// Run as early as possible
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

<!-- Hidden element for Google Translate -->
<div id="google_translate_element_hidden" style="display:none!important;height:0!important;overflow:hidden!important;"></div>