---
import merge from 'lodash.merge';
import type { ImageMetadata } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import ToBlogLink from '~/components/blog/ToBlogLink.astro';
import RelatedPosts from '~/components/blog/RelatedPosts.astro';

import { getCanonical, getPermalink } from '~/utils/blog-permalinks';
import { findPostBySlugWithContent, blogPostRobots } from '~/utils/blog';
import { findImage } from '~/utils/images';
import type { MetaData } from '~/types';
import { getBlogTypeSEO, getCategoryI18nKeys } from '~/utils/blog-seo';
import { getConsultationBreadcrumbs } from '~/utils/breadcrumbs';

// SSR: Render single post on-demand
// Uses findPostBySlugWithContent which only renders 1 post (not all)
// This prevents EMFILE errors on Netlify
export const prerender = false;

const TYPE = 'consultation';
const blogSEO = getBlogTypeSEO(TYPE);

const { slug } = Astro.params;

// Find and render ONLY this single post's content
const post = await findPostBySlugWithContent(TYPE, slug || '');

if (!post) {
  return Astro.redirect('/404');
}

const url = getCanonical(getPermalink(post.permalink, 'post', TYPE));
const image = (await findImage(post.image)) as ImageMetadata | string | undefined;

// Generate keywords from post tags and category
const postKeywords = [
  ...blogSEO.keywords.slice(0, 3),
  ...(post.category ? [post.category.title] : []),
  ...(post.tags?.map(t => t.title) || []),
];

const metadata: MetaData = merge(
  {
    title: post.title,
    description: post.excerpt,
    keywords: postKeywords.join(', '),
    robots: { index: blogPostRobots?.index, follow: blogPostRobots?.follow },
    openGraph: {
      type: 'article',
      ...(image ? { images: [{ url: image, width: (image as ImageMetadata)?.width, height: (image as ImageMetadata)?.height }] } : {}),
    },
  },
  { ...(post?.metadata ? { ...post.metadata, canonical: post.metadata?.canonical || url } : {}) }
) as MetaData;

// Generate breadcrumbs with category (i18n) and article title (translatable by Google)
const categoryI18nKeys = post.category ? getCategoryI18nKeys(post.category.slug) : null;
const breadcrumbs = getConsultationBreadcrumbs(
  post.category ? { name: post.category.title, slug: post.category.slug, i18nKey: categoryI18nKeys?.title } : undefined,
  { title: post.title, slug: post.permalink }
);
---

<Layout metadata={metadata} breadcrumbs={breadcrumbs}>
  <SinglePost type={TYPE} post={{ ...post, image: image }} url={url}>
    {post.Content ? <post.Content /> : <Fragment set:html={post.content || ''} />}
  </SinglePost>
  <ToBlogLink type={TYPE} />
  <RelatedPosts type={TYPE} post={post} />
</Layout>
