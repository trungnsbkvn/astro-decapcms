---
import merge from 'lodash.merge';
import type { ImageMetadata } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import ToBlogLink from '~/components/blog/ToBlogLink.astro';
import BlogList from '~/components/blog/List.astro';
import Headline from '~/components/blog/Headline.astro';
import Pagination from '~/components/blog/Pagination.astro';

import { getCanonical, getPermalink, getRootPathForType } from '~/utils/blog-permalinks';
import { findPostBySlug, isCategory, blogPostRobots, blogListRobots, blogCategoryRobots, getPaginatedPosts, getPaginatedPostsByCategory } from '~/utils/blog';
import { findImage } from '~/utils/images';
import type { MetaData } from '~/types';
import RelatedPosts from '~/components/blog/RelatedPosts.astro';
import { getBlogTypeSEO, getCategorySEO, getBlogListDescription, getCategoryDescription, getKeywordsString } from '~/utils/blog-seo';

const TYPE = 'consultation';
const ROOT_PATH = '/tu-van-thuong-xuyen';
const blogSEO = getBlogTypeSEO(TYPE);

// SSR: No prerender - pages render on-demand
const { path } = Astro.params;
const segments = path ? path.split('/') : [];

let post = null;
let listData = null;
let categoryData = null;

if (segments.length === 1) {
  const firstSegment = segments[0];
  const isPageNumber = /^\d+$/.test(firstSegment);
  
  if (isPageNumber) {
    const pageNumber = parseInt(firstSegment, 10);
    const { posts, totalPages } = await getPaginatedPosts(TYPE, pageNumber);
    
    if (pageNumber > totalPages || pageNumber < 1) {
      return Astro.redirect('/404');
    }

    listData = {
      pageNumber,
      totalPages,
      posts: posts.map((p) => ({
        ...p,
        permalink: `${getRootPathForType(p.type)}/${p.permalink}`,
      })),
      prevUrl: pageNumber > 1 ? (pageNumber === 2 ? ROOT_PATH : `${ROOT_PATH}/${pageNumber - 1}`) : undefined,
      nextUrl: pageNumber < totalPages ? `${ROOT_PATH}/${pageNumber + 1}` : undefined,
    };
  } else {
    // Check if it's a category first (fast) before trying post lookup
    const isCategorySlug = await isCategory(TYPE, firstSegment);
    
    if (isCategorySlug) {
      const { posts, totalPages, category } = await getPaginatedPostsByCategory(TYPE, firstSegment, 1);
      if (posts.length > 0) {
        categoryData = {
          slug: firstSegment,
          pageNumber: 1,
          category,
          posts: posts.map((p) => ({
            ...p,
            permalink: `${getRootPathForType(p.type)}/${p.permalink}`,
          })),
          totalPages,
          prevUrl: undefined,
          nextUrl: totalPages > 1 ? `${ROOT_PATH}/${firstSegment}/2` : undefined,
        };
      }
    } else {
      // Not a category, try to find as post
      post = await findPostBySlug(TYPE, firstSegment);
      if (!post) {
        return Astro.redirect('/404');
      }
    }
  }
} else if (segments.length === 2) {
  const [categorySlug, pageStr] = segments;
  const pageNumber = parseInt(pageStr, 10);
  
  if (isNaN(pageNumber) || pageNumber < 1) {
    return Astro.redirect('/404');
  }
  
  const { posts, totalPages, category } = await getPaginatedPostsByCategory(TYPE, categorySlug, pageNumber);
  
  if (posts.length === 0 || pageNumber > totalPages) {
    return Astro.redirect('/404');
  }
  
  categoryData = {
    slug: categorySlug,
    pageNumber,
    category,
    posts: posts.map((p) => ({
      ...p,
      permalink: `${getRootPathForType(p.type)}/${p.permalink}`,
    })),
    totalPages,
    prevUrl: pageNumber > 1 ? (pageNumber === 2 ? `${ROOT_PATH}/${categorySlug}` : `${ROOT_PATH}/${categorySlug}/${pageNumber - 1}`) : undefined,
    nextUrl: pageNumber < totalPages ? `${ROOT_PATH}/${categorySlug}/${pageNumber + 1}` : undefined,
  };
} else {
  return Astro.redirect('/404');
}

let metadata: MetaData;
let url: string | URL | undefined;
let image: ImageMetadata | string | undefined;

if (post) {
  url = getCanonical(getPermalink(post.permalink, 'post', TYPE));
  image = (await findImage(post.image)) as ImageMetadata | string | undefined;
  
  // Generate keywords from post tags and category
  const postKeywords = [
    ...blogSEO.keywords.slice(0, 3),
    ...(post.category ? [post.category.title] : []),
    ...(post.tags?.map(t => t.title) || []),
  ];
  
  metadata = merge(
    {
      title: post.title,
      description: post.excerpt,
      keywords: postKeywords.join(', '),
      robots: { index: blogPostRobots?.index, follow: blogPostRobots?.follow },
      openGraph: {
        type: 'article',
        ...(image ? { images: [{ url: image, width: (image as ImageMetadata)?.width, height: (image as ImageMetadata)?.height }] } : {}),
      },
    },
    { ...(post?.metadata ? { ...post.metadata, canonical: post.metadata?.canonical || url } : {}) }
  ) as MetaData;
} else if (listData) {
  metadata = {
    title: `${blogSEO.title} — Trang ${listData.pageNumber}`,
    description: getBlogListDescription(TYPE, listData.pageNumber),
    keywords: getKeywordsString(blogSEO.keywords),
    robots: { index: blogListRobots?.index && listData.pageNumber === 1, follow: blogListRobots?.follow },
    openGraph: { type: 'article' },
  };
} else if (categoryData) {
  const categorySEO = getCategorySEO(TYPE, categoryData.slug);
  const categoryTitle = categoryData.category?.title || categoryData.slug;
  const isFirstPage = categoryData.pageNumber === 1;
  metadata = {
    title: categorySEO?.title 
      ? (isFirstPage ? `${categorySEO.title} - ${blogSEO.title}` : `${categorySEO.title} - Trang ${categoryData.pageNumber} - ${blogSEO.title}`)
      : (isFirstPage ? `Danh mục: ${categoryTitle}` : `Danh mục: ${categoryTitle} - Trang ${categoryData.pageNumber}`),
    description: getCategoryDescription(TYPE, categoryData.slug, categoryTitle, categoryData.pageNumber),
    keywords: categorySEO ? getKeywordsString(categorySEO.keywords) : getKeywordsString(blogSEO.keywords),
    robots: { index: blogCategoryRobots?.index && isFirstPage, follow: blogCategoryRobots?.follow },
  };
}
---

{post ? (
  <Layout metadata={metadata}>
    <SinglePost type={TYPE} post={{ ...post, image: image }} url={url}>
      {post.Content ? <post.Content /> : <Fragment set:html={post.content || ''} />}
    </SinglePost>
    <ToBlogLink type={TYPE} />
    <RelatedPosts type={TYPE} post={post} />
  </Layout>
) : listData ? (
  <Layout metadata={metadata}>
    <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-4xl">
      <Headline subtitle={blogSEO.subtitle}>
        {blogSEO.title}
      </Headline>
      <BlogList posts={listData.posts} />
      <Pagination prevUrl={listData.prevUrl} nextUrl={listData.nextUrl} />
    </section>
  </Layout>
) : categoryData ? (
  <Layout metadata={metadata}>
    <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-4xl">
      <Headline subtitle={getCategorySEO(TYPE, categoryData.slug)?.subtitle || `Tất cả bài viết trong danh mục ${categoryData.category?.title || categoryData.slug}`}>
        {getCategorySEO(TYPE, categoryData.slug)?.title || categoryData.category?.title || categoryData.slug}
      </Headline>
      <BlogList posts={categoryData.posts} />
      <Pagination prevUrl={categoryData.prevUrl} nextUrl={categoryData.nextUrl} />
    </section>
  </Layout>
) : null}
