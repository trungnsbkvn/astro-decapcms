[build]
  publish = "dist"
  command = "pnpm run build"
  # With hybrid mode, content changes still need a build to update the server functions
  # But the build is much faster since images/static assets are cached

[build.environment]
  NODE_VERSION = "20"
  # Enable Sharp caching for faster image processing
  SHARP_IGNORE_GLOBAL_LIBVIPS = "1"
  # Disable Astro telemetry
  ASTRO_TELEMETRY_DISABLED = "1"

[build.processing.html]
  pretty_urls = false

# Cache Astro's processed images between builds for faster deploys
[[plugins]]
  package = "netlify-plugin-cache"
  [plugins.inputs]
    # Cache the Astro image cache directory
    paths = [
      "node_modules/.astro",
      ".astro"
    ]

# Note: Redirects are automatically handled by @astrojs/netlify adapter
# The adapter generates the necessary _redirects file

# Cache static assets indefinitely (hash-busted by Astro)
[[headers]]
  for = "/_astro/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache HTML pages for 1 hour, allow CDN to serve stale while revalidating
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=3600, stale-while-revalidate=86400"

# Dynamic content pages - shorter cache
[[headers]]
  for = "/tin-tuc/*"
  [headers.values]
    Cache-Control = "public, max-age=300, stale-while-revalidate=3600"

[[headers]]
  for = "/phap-ly/*"
  [headers.values]
    Cache-Control = "public, max-age=300, stale-while-revalidate=3600"

[[headers]]
  for = "/lao-dong/*"
  [headers.values]
    Cache-Control = "public, max-age=300, stale-while-revalidate=3600"

# Enable Netlify Image CDN for on-demand image optimization
[images]
  remote_images = ["https://cdn.pixabay.com/.*"]