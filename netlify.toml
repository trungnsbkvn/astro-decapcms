[build]
  publish = "dist"
  command = "pnpm run build"
  # SSR Mode: Content is bundled at build time, pages render on-demand
  # When content changes via Decap CMS:
  #   1. Decap commits to GitHub
  #   2. GitHub triggers Netlify deploy (automatic)
  #   3. Netlify rebuilds (~2-3 min) and deploys
  #   4. New deploy invalidates CDN cache automatically
  #   5. New content is immediately available

[build.environment]
  NODE_VERSION = "20"
  # Enable Sharp caching for faster image processing
  SHARP_IGNORE_GLOBAL_LIBVIPS = "1"
  # Disable Astro telemetry
  ASTRO_TELEMETRY_DISABLED = "1"

# Enable asset optimization (Netlify handles compression)
[build.processing]
  skip_processing = false
[build.processing.css]
  bundle = true
  minify = true
[build.processing.js]
  bundle = true
  minify = true
[build.processing.html]
  pretty_urls = false

# Cache Astro's processed images between builds for faster deploys
[[plugins]]
  package = "netlify-plugin-cache"
  [plugins.inputs]
    # Cache the Astro image cache directory
    paths = [
      "node_modules/.astro",
      ".astro"
    ]

# Local plugin to log cache purge on deploy
[[plugins]]
  package = "./netlify/plugins/cache-purge"

# Note: Redirects are automatically handled by @astrojs/netlify adapter
# The adapter generates the necessary _redirects file

# Cache static assets indefinitely (hash-busted by Astro)
[[headers]]
  for = "/_astro/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# =============================================================================
# SSR Blog Pages Caching Strategy (Aggressive caching for rarely-changed content)
# =============================================================================
# - max-age=86400 (24 hours): Browser/CDN serves cached version for 1 day
# - stale-while-revalidate=604800 (7 days): Serves stale while fetching fresh
# - stale-if-error=2592000 (30 days): Serves stale if origin errors
#
# Result: 
#   - Most users get instant cached responses (24h fresh cache)
#   - After 24h, still serves cached while revalidating in background
#   - Site stays up for 30 days even if origin has issues
#
# Cache Invalidation Options:
#   1. Netlify Dashboard > Deploys > Clear cache and deploy
#   2. POST to /.netlify/functions/purge-cache (webhook from Decap CMS)
#   3. Netlify API: POST /api/v1/purge with Cache-Tag header
# =============================================================================

[[headers]]
  for = "/tin-tuc/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, stale-if-error=2592000"
    CDN-Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, durable"
    Cache-Tag = "blog, tin-tuc"

[[headers]]
  for = "/phap-ly/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, stale-if-error=2592000"
    CDN-Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, durable"
    Cache-Tag = "blog, phap-ly"

[[headers]]
  for = "/lao-dong/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, stale-if-error=2592000"
    CDN-Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, durable"
    Cache-Tag = "blog, lao-dong"

[[headers]]
  for = "/tu-van-thuong-xuyen/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, stale-if-error=2592000"
    CDN-Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, durable"
    Cache-Tag = "blog, tu-van-thuong-xuyen"

[[headers]]
  for = "/dau-tu-nuoc-ngoai/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, stale-if-error=2592000"
    CDN-Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, durable"
    Cache-Tag = "blog, dau-tu-nuoc-ngoai"

[[headers]]
  for = "/dich-vu-danh-gia/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, stale-if-error=2592000"
    CDN-Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, durable"
    Cache-Tag = "blog, dich-vu-danh-gia"

[[headers]]
  for = "/tag/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, stale-if-error=2592000"
    CDN-Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, durable"
    Cache-Tag = "blog, tags"

# Static pages - longer cache (1 week fresh, 30 days stale)
[[headers]]
  for = "/"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, stale-if-error=2592000"
    Cache-Tag = "static, homepage"

[[headers]]
  for = "/gioi-thieu"
  [headers.values]
    Cache-Control = "public, max-age=604800, stale-while-revalidate=2592000"
    Cache-Tag = "static"

[[headers]]
  for = "/lien-he"
  [headers.values]
    Cache-Control = "public, max-age=604800, stale-while-revalidate=2592000"
    Cache-Tag = "static"

[[headers]]
  for = "/dich-vu"
  [headers.values]
    Cache-Control = "public, max-age=604800, stale-while-revalidate=2592000"
    Cache-Tag = "static"

# API endpoints - cache search data for 1 day
[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800"
    CDN-Cache-Control = "public, max-age=86400, stale-while-revalidate=604800, durable"
    Cache-Tag = "api"

# RSS feed caching (1 day)
[[headers]]
  for = "/rss.xml"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800"
    Content-Type = "application/rss+xml; charset=utf-8"
    Cache-Tag = "feed"

# Sitemap caching (1 day)
[[headers]]
  for = "/sitemap*.xml"
  [headers.values]
    Cache-Control = "public, max-age=86400, stale-while-revalidate=604800"
    Cache-Tag = "sitemap"

# Security headers for all pages
[[headers]]
  for = "/*"
  [headers.values]
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "SAMEORIGIN"
    Referrer-Policy = "strict-origin-when-cross-origin"

# Enable Netlify Image CDN for on-demand image optimization
[images]
  remote_images = ["https://cdn.pixabay.com/.*"]